

 
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>预收款单</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		 
		<link rel="stylesheet" href="/JLPSI/junlin/css/bootstrap.min.css" />
		<link rel="stylesheet" href="/JLPSI/junlin/css/ace.min.css" />
		<link rel="stylesheet" href="/JLPSI/junlin/css/style.css" />
		<link rel="stylesheet" href="/JLPSI/junlin/css/style_i.css" />
		<link rel="stylesheet" href="/JLPSI/junlin/font/css/font-awesome.min.css" />
		<link rel="stylesheet" href="/JLPSI/junlin/js/layer3.1.1/theme/default/layer.css" />
		<!--[if IE 7]>
		  <link rel="stylesheet" href="/JLPSI/junlin/font/css/font-awesome-ie7.min.css" />
		  <link rel="stylesheet" href="/JLPSI/junlin/css/ace-ie.min.css" />
		<![endif]-->

		<link rel="stylesheet" href="/JLPSI/junlin/css/mine/all.css" />
		<link rel="stylesheet" href="/JLPSI/junlin/css/mine/public.css" />

		<script src="/JLPSI/junlin/js/jquery-1.10.2.min.js"></script>
		<!--<script src="/JLPSI/junlin/js/bootstrap.min.js"></script>-->
		<script src="/JLPSI/junlin/js/typeahead-bs2.min.js"></script>
		<script src="/JLPSI/junlin/js/jquery.dataTables.min.js"></script>
		<script src="/JLPSI/junlin/js/jquery.dataTables.bootstrap.js"></script>
		<script src="/JLPSI/junlin/js/layer3.1.1/layer.js" type="text/javascript"></script>
		<script src="/JLPSI/junlin/js/laydate/laydate.js" type="text/javascript"></script>
		<script src="/JLPSI/junlin/script/public.js" type="text/javascript"></script>
		<script src="/JLPSI/junlin/js/date.js" type="text/javascript"></script>
		<script src="/JLPSI/junlin/script/DetailBill-2.2.js" type="text/javascript"></script>
		  <link
			href="/JLPSI/junlin/js/jQuery-searchableSelect/jquery.searchableSelect.css"
			rel="stylesheet" type="text/css">
		 <script
			src="/JLPSI/junlin/js/jQuery-searchableSelect/jquery.searchableSelect.js"></script>
		<script src="/JLPSI/junlin/script/billOrder.js" type="text/javascript"></script>
		
		<style>
			#editDiv,#detailDiv {
				padding-top: 20px;
			}
				#bill{
			width: 100%;
			}
			#dateSearch{
			width:190px
			}
		</style>
	</head>

	<body class="content">
		<div class="page-content clearfix">
			<div id="Member_Ratings">
				<div class="d_Confirm_Order_style" style="margin-top:10px;">
					<h4 class="text-title">预收款单</h4>
					<div class="search-div clearfix">
						<div class="clearfix">
							<span class="l_f"> 
							往来单位：
									<select  id="query_customerSupplierId" onchange="intercourseUnitChange(this)">
										<option value="">--请选择往来单位--</option>
									
									</select>
							   <!-- <input type="text" id="query_customerSupplierId" value="" onblur="cky(this)"/> -->
						</span>
							<span class="l_f"> 
							单号： <input type="text" id="query_billsCode" value="" onblur="cky(this)"/>
						</span>
							<span class="l_f"> 
								日期： <input type="text"  value="" id="dateSearch" placeholder="请选择日期" readonly="readonly" />
							</span>
							<span class="r_f"> 
							<input type="button"  class="btncss btn_search" id="btn_search" value="搜索" />
						</span>
						</div>


					</div>
					<div class="opration-div clearfix">

						<span class="r_f"> 
							<button type="button" class="btncss jl-btn-defult" onclick="advancesReceivedAdd()"><i class="fa fa-plus"></i> 新增</button>
						</span>

					</div>
					<div class="table_menu_list">
						<table class="table table-striped table-hover col-xs-12" id="datatable">
							<thead class="table-header">
								<tr>
									<th>单号 </th>
									<th>往来单位</th>
									<th>结算金额</th>
									<th>银行</th>
									<th>银行账户</th>
									<th>制单人</th>
									<th>创建时间</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody>
						 
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!--新增 编辑 -->
		<div id="editDiv" style="display: none;">
			<form class="container">
			 <input type="text" class="form-control hidden" id="edit_id" />
			
				<div class="row jl-title">
					<span>基本信息</span>
				</div>
				<div class="jl-panel" id="headEdit">
					<div class="row">
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">往来单位</label>
								<div class="col-xs-8" id="edit_supctoIdDiv">
									<select id="intercourseUnit" class="form-control">
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="row jl-title">
					<span>单据引用</span>
					<i class="r_f"> 
						<button type="button" class="btncss jl-btn-importent" onclick="documentReference()">引用单据</button>
					</i>
					<i class="r_f">
					<select id="bill" disabled="disabled"  style="width: 100%">
						<option value="-1">--请选择单据--</option>
						<option value="123" attr-date="date" attr-money="1000" attr-alreadyPrice="90">44</option>
					</select>
					</i>
				</div>
				<div class="row">
					<table class="table table-bordered table-striped table-hover col-xs-12" border="" cellspacing="0" cellpadding="0">
						<tbody id="billTbody">
							<tr>
								<th>单据编号</th>
								<th>单据日期</th>
								<th>订单金额</th>
								<th>已结算预收金额</th>
								<th>本次收款</th>
								<th>备注</th>
								<th>单据类型</th>
								<th>操作</th>
							</tr>
							<tr class="tipTr">
								<td colspan="8">请先选择单据</td>
							</tr>
						</tbody>
					</table>
				</div>
				
				<div class="row jl-title">
					<span>收款</span>
				</div>
				<div class="jl-panel" id="middleEdit">
					<div class="row">
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">币种</label>
								<div class="col-xs-8">
									<input type="text" id="currency" class="form-control"  value="人民币" disabled="disabled"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">金额</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="totalAmount" value=""  disabled="disabled"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">结算方式</label>
								<div class="col-xs-8">
									<select id="payment" class="form-control">
										 
									</select>
								</div>
							</div>
						</div>
						 <div class="col-md-6 col-xs-6" id="payment_money_div">
							<!-- <div class="form-group">
								<label for="" class="col-xs-4 control-label">预付金额</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="payment_money" value=""/>
								</div>
							</div> -->
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">收款账户</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="account" value="" onblur="cky(this)"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">开户银行</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="bank" value="" onblur="cky(this)"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">银行账号</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="bankAccount" value="" onblur="cky(this)"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">票号</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="ticketNo" value="" onblur="cky(this)"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">备注</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="remark" value="无" onblur="cky(this)"/>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row jl-title">
					<span>其他</span>
				</div>
				<div class="jl-panel" id="footerEdit">
					<div class="row">
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">部门</label>
								<div class="col-xs-8">
										<select id="department_id" class="form-control" name="departmentId" >
									<option value="-1" selected="selected">--请选择--</option>
								
								</select>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">业务员</label>
							<div class="col-xs-8">
							<select id="person_id" class="form-control" name="personId" >
							 	<option value="-1" selected="selected">--请先选择部门--</option>
								
						 	</select>
						</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">摘要</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="summary" value="无" onblur="cky(this)"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">分支机构</label>
								<div class="col-xs-8">
									<select class="form-control">
										<option value="-1">--请选择分支机构--</option>
										<option value="1">总部</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="text-danger">注：该页面所有字段均为必填</div>
			</form>

		</div>
		<div id="detailDiv" style="display: none;">
			<form class="container">
				<div class="row jl-title">
					<span>基本信息</span>
				</div>
				<div class="jl-panel">
					<div class="row">
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label" >日期：</label>
								<div class="col-xs-8" id="de_billsDate">
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label"  >单号：</label>
								<div class="col-xs-8" id="de_billsCode">
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label" >往来单位：</label>
								<div class="col-xs-8" id="de_customerSupplierName">
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">收款类型：</label>
								<div class="col-xs-8">
									预收款
								</div>
							</div>
						</div>
						 <div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label"  >预收金额：</label>
								<div class="col-xs-8" id="de_balance">
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="row jl-title">
					<span>单据</span>
				</div>
				<div class="row">
					<table class="table table-bordered table-striped table-hover col-xs-12" border="" cellspacing="0" cellpadding="0">
						<tbody id="detailTbody">
							<tr>
								<th>单据编号</th>
								<th>单据日期</th>
								<th>订单金额</th>
								<th>已结算预收金额</th>
								<th>本次收款</th>
								<th>备注</th>
								<th>单据类型</th>
							</tr>
				 
						</tbody>
					</table>
				</div>
				
				<div class="row jl-title">
					<span>收款</span>
				</div>
				<div class="jl-panel">
					<div class="row">
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">币种：</label>
								<div class="col-xs-8">
									人民币
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">金额：</label>
								<div class="col-xs-8" id="de_money">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">结算方式：</label>
								<div class="col-xs-8" id="de_paymentName" >
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">收款账户：</label>
								<div class="col-xs-8" id="de_account">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">开户银行：</label>
								<div class="col-xs-8" id="de_bank">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">银行账号：</label>
								<div class="col-xs-8" id="de_bankAccount">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">票号：</label>
								<div class="col-xs-8" id="de_ticketNo">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">备注：</label>
								<div class="col-xs-8" id="de_remark">
									
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="row jl-title">
					<span>其他</span>
				</div>
				<div class="jl-panel">
					<div class="row">
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">部门：</label>
								<div class="col-xs-8" id="de_departmentName">
									
								</div>
							</div>
						</div>
 
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">业务员：</label>
								<div class="col-xs-8" id="de_personName">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">制单人：</label>
								<div class="col-xs-8" id="de_originatorName">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">摘要：</label>
								<div class="col-xs-8" id="de_summary">
									
								</div>
							</div>
						</div>
						<div class="col-md-6 col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">分支机构：</label>
								<div class="col-xs-8" id="de_branch">
									
								</div>
							</div>
						</div>
					</div>
				</div>
				
			</form>

		</div>

	</body>

	<script>
		laydate.render({
	        elem: "#dateSearch",
	        range:'~'
	    });
		let goodsArr=[];
		$(function(){
			
			 
				/*加载部门列表 */
				$.ajax({
					url :'/JLPSI//basic/department/getAllDepartment' ,
					type : "POST",
					dataType : "json",
					data: {},
					success : function(data) {
						$("#department_id").empty();
						if(data.length==0){
							$("#department_id").append('<option value="-1" selected="selected">--暂无部门信息，请去添加--</option>');
						}
						else{
							$("#department_id").append('<option value="-1" selected="selected">--请选择--</option>');
							for ( var i = 0; i < data.length; i++) {
								var option = $("<option  value='"+data[i].id+"'>"+ data[i].name +"</option>");
								$("#department_id").append(option);
								
							}
						}
						
					}
				});
				
				//加载业务员列表
				$("#department_id").change(function(){
					if($("#department_id").val()==-1){
						$("#person_id").empty();
						$("#person_id").append('<option value="-1" selected="selected">--请先选择部门--</option>');
					}
					else{
						person(0);
					}
		
				})
				getAllSettlementType();
				$("#payment").on("change",function(){
					if($("#payment").val()==1){
						$("#payment_money_div").html(`<div class="form-group">
								<label for="" class="col-xs-4 control-label">预收金额</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" name="" id="payment_money" value="" onkeyup="pressMoney(this)"/>
								</div>
							</div>`);
					}else{
						$("#payment_money_div").html("");
					}
				})
		})
		
		      /* 获取所有结算方式*/
		        function getAllSettlementType(){
		            $.ajax({
		                url: '/JLPSI/basic/settlementType/getAllSettlementType',
		                type: "POST",
		                dataType: "json",
		                async: false,
		                cache: false,
		                success: function(data) {

		                    if(data.length==0){
		                        $("#payment").append("<option value='-1' selected>--暂无数据，请到结算方式页面进行添加。--</option>");
		                    }
		                    else{
		                        $("#payment").append("<option value='-1' selected>--请选择--</option>");
		                        for(var i=0;i<data.length;i++){
		                            var option = $("<option value='"+data[i].id+"'>"
		                                + data[i].name + "</option>");
		                            $("#payment").append(option);
		                        }
		                    }
		                }
		            });
				}
		
				function person(personId){
			/* 业务员下拉框赋值 */
			$.ajax({
				url :'/JLPSI//basic/person/getAllPersonByDepartmentIdAndBusiness' ,
				type : "POST",
				dataType : "json",
				data: {
					"departmentId" : $("#department_id").val()
				},
				success : function(data) {
					$("#person_id").empty();
					if(data.length==0){
						$("#person_id").append('<option value="-1" selected="selected">--该部门暂无业务员，请去添加--</option>');
					}
					else{
						$("#person_id").append('<option value="-1" selected="selected">--请选择--</option>');
						for ( var i = 0; i < data.length; i++) {
							var option = $("<option  value='"+data[i].id+"'>"+ data[i].name +"</option>");
							$("#person_id").append(option);
							
						}
						if(personId>0){
							$("#person_id").val(personId);
						}
					}
					
				}
			});
		}
		
		/*修改*/
		function advancesReceivedEdit() {
			/*
			 * 请在此处添加页面内容赋值代码
			 */
			
			orderBillEdit("预收款单",function(){
				/*
				 * 请在此处添加点击提交按钮后的代码
				 */
			})
		}
		/*新增*/
		function advancesReceivedAdd() {
			//初始化往来单位
			initIntercourseUnitSelect();
			//初始化单据select
 			$('#bill').parent().html('<select id="bill"  disabled="disabled"><option value="-1">--请选择往来单位--</option></select>');
			
			orderBillAdd("预收款单",function(index){
				/*
				 * 请在此处添加点击提交按钮后的代码
				 */
				 if(checkInputHaveZero("amountPayment")){
					 layfail("本次收款金额不得为0！");
				 }else{
					 $.ajax({
							url: '/JLPSI/receivable/bills/saveBills',
							type: "POST",
							dataType: "json",
							data:{
								"billsJson":JSON.stringify(getDataJSON())
							},
							async: false,
							cache: false,
							success: function(data) {
								if(data.success) {
									laysuccess(data.msg);
									oTable1.fnDraw(false);
									$("#checkAll").removeAttr("checked");
								} else {
									layfail(data.msg);
								}
								layer.close(index);
								laysuccess("预收款单保存成功");
							}
						});
				 }
 				
			})
		}
		
		/*详情*/
		function advancesReceivedDetail(row){
			/*
			 * 请在此处添加页面内容赋值代码
			 */
 
			 
	            $("#detailDiv").html("");
				$.ajax({
					type: "post",
					url: "/JLPSI/receivable/bills/billsDetail",
					dataType : "json",
					data: {
						"id" : row.id
					},
					success: function(res) {
						let bill = new DetailBill(res,2);
						let $content = bill.toPrint();
						$("#detailDiv").html($content);
					}
				});
			
			orderBillDetail("预收款单");
		}
		
		
		

		
		
		
		/*单据引用*/
		function documentReference() {
			let documentNum = $("#bill").val();
			let procureSalesId=$("#bill option:selected").attr("procureSalesId");
			let datetime = $("#bill option:selected").attr("attr-date");
			let price = toDecimal2($("#bill option:selected").attr("attr-money"));
			let clearingMoney=toDecimal2($("#bill option:selected").attr("attr-alreadyPrice"));
	
			if($("#intercourseUnit").val()=="-1"){
				layfail("请先选择往来单位!");
			}else if(documentNum == -1) {
				layfail("请先选择单据!");
			} else if(!checkRepeat(documentNum,goodsArr)) {
				$(".tipTr").remove();
				goodsArr.push(documentNum);
				
		/* 		var billsSubsDataJSON={"id":$(val).find(".subId").val(),"billsId":$("#edit_id").val(),"procureSalesId":$(val).find(".procureSalesId").val(),"clearingMoney":$(val).find(".clearingMoney").val(),"stayMoney":$(val).find(".stayMoney").val(),
    					"theMoeny":$(val).find(".theMoeny").val(),"actualMoney":$(val).find(".actualMoney").val(),"rebateMoney":$(val).find(".rebateMoney").val(),"isPayment":$(val).find(".isPayment").val(),
    					"rebate":rebate,"remark":$(val).find(".remark").val()};	 */
				
				$("#billTbody").append('<tr class="subData" ><td style="display:none" class="subId"></td><td style="display:none" class="procureSalesId">'+procureSalesId+'</td><td class="documentNum">' + documentNum + '</td><td>' + datetime + '</td><td class="price">' + price + 
					'</td><td class="alreadyPrice clearingMoney">' + clearingMoney + '</td><td><input type="text" class="form-control amountPayment theMoeny" onkeyup="amountPaymentOnKeyUp(this)" attr-name="本次收款"/></td></td>' +
					'<td><input type="text" class="form-control remark" onblur="cky(this)" value="无" attr-name="备注"/></td>' +
					'<td>销售订单</td>' +
					'<td><input type="button" class="btncss edit" onclick="billDel(this)" value="删除" /></td></tr>');
			} else {
				layfail("请勿重复选择单据！");
			}
		}

		/*删除商品*/
		function billDel(thisbtn) {
			let documentNum = $(thisbtn).parents("tr").find(".documentNum").html();
			goodsArr.remove(documentNum);
			$(thisbtn).parents("tr").remove();
			countTotalAmount();
			if($("#billTbody tr").length == 1) {
				$("#billTbody").append('<tr class="tipTr"><td colspan="8">请先选择单据</td></tr>');
			}
			countTotalAmount();
		}

		/*查重*/
		function checkRepeat(id,goodsArr) {
			let flag = false;
			for(var i in goodsArr) {
				if(goodsArr[i] == id) {
					flag = true;
				}
			}
			return flag;
		}

		/*清空单据*/
		function clearBill() {
			$("#billTbody").html('<tr><th>单据编号</th><th>单据日期</th><th>订单金额</th><th>已结算预收金额</th><th>本次收款</th><th>备注</th><th>单据类型</th><th>操作</th></tr>' +
				'<tr class="tipTr"><td colspan="8">请先选择单据</td></tr>');
			goodsArr = [];
			countTotalAmount();
		}
		
		//初始化往来单位
		function initIntercourseUnitSelect() {
			$("#intercourseUnit").parent().html('<select id="intercourseUnit" class="form-control"><option value="-1">--请选择往来单位--</option></select>');

			//加载供应商消息
			 $.ajax({
	                url: '/JLPSI/basic/supctoManager/getSupctoMsgByCustomerOrSupplier',
	                type: "POST",
	                dataType: "json",
	                async: false,
	                cache: false,
	                data:{
	                	"customerOrSupplier":1
	                },
	                success: function(data) {
	                	for(var i=0;i<data.length;i++){
		                	$('#intercourseUnit').append('<option value="'+data[i].id+'">'+data[i].name+'</option>')
							$('#query_customerSupplierId').append('<option  value="'+data[i].id+'">'+data[i].name+'</option>')
	                	}
	                	$("#intercourseUnit").searchableSelect();
	                }
	            });

			
		}
		
		/*往来单位change事件*/
		function getCommodityMsg(value){
			clearBill();
			if(value=="-1"){
				$('#bill').parent().html('<select id="bill"  disabled="disabled"><option value="-1">--请选择往来单位--</option></select>');
			}else{
				$('#bill').attr("disabled",false);
				$('#bill').parent().html('<select id="bill" ><option value="-1">--请选择单据--</option></select>');
				
				 $.ajax({
		                url: '/JLPSI//receivable/bills/subList',
		                type: "POST",
		                dataType: "json",
		                async: false,
		                cache: false,
		                data:{
		                	"supctoId":value,
		                	"billsType":3
 		                },
		                success: function(data) {
		                	
		               	 if(data.success){
		               		var subList=data.subList;
		               		if(subList.length==0){
		               			$('#bill').parent().html('<select id="bill" disabled="disabled"><option value="-1">暂无引用单据</option></select>');
		               			return;
		               		}
		               		for(var i=0;i<subList.length;i++){
		               			var clearingMoney=0;
		               			if(subList[i].clearingMoney!=null){
		               				clearingMoney=toDecimal2(subList[i].clearingMoney);
		               			}
		               			var orderTime=getSmpFormatDateByLong(subList[i].orderTime, true);
 		        				$('#bill').append('<option value="'+subList[i].identifier+'" procureSalesId="'+subList[i].procureSalesId+'"attr-date="'+orderTime+'" attr-money="'+toDecimal2(subList[i].orderMoney)+'" attr-alreadyPrice="'+clearingMoney+'">'+subList[i].identifier+'</option>');
 		        				
		                	}
		               		$("#bill").searchableSelect();
		               	 }else{
		               		layfail("请求异常");
		               	 }
		                }
		            });
				/*请在此处为单据下拉框赋值*/
				//$('#bill').append('<option value="44" attr-date="date" attr-money="1000" attr-alreadyPrice="90">44</option>')
			}
		}
		function amountPaymentOnKeyUp(thisInput){
			pressMoney(thisInput);
			
			if($(thisInput).val()!=""){
				let parentTr=$(thisInput).parents("tr");
				let alreadyPrice=parentTr.find(".alreadyPrice").html()-0;
				let price=parentTr.find(".price").html()-0;
				let amountToBeSettled=price-alreadyPrice;
				let amountPayment=$(thisInput).val()-0;
				if(amountPayment==0){
					layfail("本次收款金额不能为0！");
					$(thisInput).val("");
				}
				/* if(amountToBeSettled<amountPayment){
					layfail("本次结算金额不能大于待结算预收金额！");
					$(thisInput).val("");
				} */
			}
			countTotalAmount();
			
			
		}
		
		/*计算总金额*/
		function countTotalAmount(){
			let totalAmount=0;
			$(".amountPayment").each(function(index,obj){
				if($(obj).val()!=""){
					totalAmount+=($(obj).val()-0);
				}
			})
			$("#totalAmount").val(toDecimal2(totalAmount));
		}
		
		
    	/* 提交或者编辑时 把数据整合成json传入后台 */
    	function getDataJSON(){
    	 
    		 
    		//预收款单
    		 var  billsDataJson={"id":$("#edit_id").val(),"customerSupplierId":$("#intercourseUnit").val(),"billsType":3,"bank":$("#bank").val(),
    				"bankAccount":$("#bankAccount").val(),"payment":$("#payment").val(),"personId":$("#person_id").val(),"ticketNo":$("#ticketNo").val(),"money":$("#totalAmount").val(),
    				"remark":$("#remark").val(),"summary":$("#summary").val(),"account":$("#account").val(),
    				"billsSubs":[]}; 
    			if($("#payment").val()==1){
        			billsDataJson.balance=$("#payment_money").val();
        		}
    		//获取预收款单子信息，加入预收款单主信息
    		$("#billTbody .subData").each(function(index, val){
    			 
    		 
    			var billsSubsDataJSON={"procureSalesId":$(val).find(".procureSalesId").html(),"clearingMoney":$(val).find(".clearingMoney").html(),"stayMoney":$(val).find(".stayMoney").html(),
    					"theMoeny":$(val).find(".theMoeny").val(),"actualMoney":$(val).find(".actualMoney").html(),"rebateMoney":$(val).find(".rebateMoney").html(),"isPayment":$(val).find(".isPayment").val(),
    					"rebate":$(val).find(".rebate").val(),"remark":$(val).find(".remark").val()};	
    				
    			billsDataJson.billsSubs[index]=billsSubsDataJSON;	
    			});
    			
    		
    		return billsDataJson; 
    	}
    	
    	//分页
    	    	var oTable1;
    		$("#btn_search").click(function() {
		
		$("#checkAll").removeAttr("checked");
		oTable1.fnDraw();
	});
    		jQuery(function($) {
		//datatable赋值
		oTable1 = $('#datatable')
			.dataTable({
				"aaSorting": [
					[0, "desc"]
				], //默认第几个排序
				"bStateSave": false, //状态保存
				"bLengthChange": false, //改变每页显示数据数量
				"bFilter": false, //列搜索
				"iDisplayLength": 10, //默认每页显示的记录数
				"iDisplayStart": 0,
				"bServerSide": true, //是否开启服务端查询
				"sDom": 't<"row"<"col-sm-6"i><"col-sm-6"p>>',
				"ajax": {
					"type": "post",
					"dataType": "json",
					"async": false,
					"data": function(d) {
						return $.extend({}, d, {
							//添加额外的参数传给服务器(可以多个)
									//添加额外的参数传给服务器(可以多个)
							"page":1,
							 "billsType":3,
							"billsCode": $("#query_billsCode").val(),
							"customerSupplierId": $("#query_customerSupplierId").val(),
							"dateSearch":$("#dateSearch").val()		 	
						});
					},
					"url": "/JLPSI/receivable/bills/dataTables3"
				},
				"aoColumns": [ 
					
					{
						"mData": "billsCode",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						"mRender" : function(data, type, row) {
							return '<td><span class="look-span"    onclick=\'advancesReceivedDetail(' + JSON.stringify(row) + ')\'>'
									+ data
									+ '</span></td>';
						}
						
					},
					{
						"mData": "customerSupplierName",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						
					},
					{
						"mData": "money",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						
					},
					{
						"mData": "bank",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						
					},
					{
						"mData": "bankAccount",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						
					},
					{
						"mData": "originatorName",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						
					},
					{
						"mData": "billsDate",
						"bSortable": false,
						"sClass": "center",
						"sWidth": "15%",
						"mRender": function(data) {
								if(data!=null&&data!=""){
								return getSmpFormatDateByLong(data, true);
							}else{
								return "";
								}
							
						}
					},
					
					{
						"mData": "id",
						"bSortable": false,
						"sWidth": "10%",
						"sClass": "center",
						"mRender": function(data, type, row) {

							return '<td><input type="button" class="btncss edit"' +
								'onclick=\'advancesReceivedDetail(' + JSON.stringify(row) + ')\' value="详情" />'
						}
					}
				 
				 
				],
				"oLanguage": {
					// 国际化配置
					"sLengthMenu": "每页显示 _MENU_ 条记录",
					"sZeroRecords": "没有数据记录",
					"sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
					"sInfoEmpty": "",
					"sInfoFiltered": "(全部记录数 _MAX_ 条)",
					"oPaginate": {
						"sFirst": "首页",
						"sPrevious": "前一页",
						"sNext": "后一页",
						"sLast": "尾页"
					}
				}
			});
		

	});
	</script>

</html>